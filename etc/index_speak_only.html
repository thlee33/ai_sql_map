<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>ìŒì„±ì¸ì‹ GIS ëŒ€ì‹œë³´ë“œ</title>
    
    <script src='https://unpkg.com/maplibre-gl@4.1.3/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@4.1.3/dist/maplibre-gl.css' rel='stylesheet' />
    
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10;
            width: 300px;
        }
        
        #btnVoice {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        #btnVoice:hover { background-color: #0056b3; }
        
        #status {
            margin-top: 15px;
            font-size: 14px;
            color: #555;
            min-height: 40px;
        }

        /* LLMì´ ìƒì„±í•œ ì¿¼ë¦¬ í‘œì‹œ (ë””ë²„ê¹…ìš©) */
        #sqlResult {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 10;
            font-family: monospace;
            max-width: 500px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>

<div id='map'></div>

<div id="controls">
    <h3>ìŒì„± ëª…ë ¹</h3>
    <button id="btnVoice">ğŸ™ï¸ (ëˆŒëŸ¬ì„œ ë§í•˜ê¸°)</button>
    <div id="status">ëª…ë ¹ ëŒ€ê¸° ì¤‘...</div>
</div>

<pre id="sqlResult"></pre>


<script>
    // --- 1. MapLibre ì§€ë„ ì´ˆê¸°í™” ---
    const map = new maplibregl.Map({
        container: 'map',
        // ì˜¤í”ˆì†ŒìŠ¤ OSM ë²¡í„° íƒ€ì¼ ì‚¬ìš©
        style: 'https://api.maptiler.com/maps/streets-v2/style.json?key=get_your_own_OpIi9ZULNADoOIi7_nkT', 
        center: [126.9380, 37.6000], // ì„œìš¸ ë…¹ë²ˆë™ ì¤‘ì‹¬
        zoom: 15
    });

    map.on('load', () => {
        // ë¶„ì„ ê²°ê³¼ë¥¼ ë‹´ì„ ë¹ˆ GeoJSON ì†ŒìŠ¤ ì¶”ê°€
        map.addSource('analysis-results', {
            type: 'geojson',
            data: {
                type: 'FeatureCollection',
                features: []
            }
        });
        
        // ë¶„ì„ ê²°ê³¼ ë ˆì´ì–´ (ì )
        map.addLayer({
            id: 'results-points',
            type: 'circle',
            source: 'analysis-results',
            paint: {
                'circle-radius': 8,
                'circle-color': '#FF0000',
                'circle-stroke-width': 2,
                'circle-stroke-color': '#FFFFFF'
            }
        });
    });

    // --- 2. Web Speech API (ìŒì„± ì¸ì‹) ì„¤ì • ---
    const btnVoice = document.getElementById('btnVoice');
    const statusEl = document.getElementById('status');
    const sqlResultEl = document.getElementById('sqlResult');

    // ë¸Œë¼ìš°ì € í˜¸í™˜ì„± ì²´í¬
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        statusEl.textContent = "ì˜¤ë¥˜: ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (í¬ë¡¬ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”)";
        btnVoice.disabled = true;
    } else {
        const recognition = new SpeechRecognition();
        recognition.lang = 'ko-KR'; // í•œêµ­ì–´ ì„¤ì •
        recognition.continuous = false; // í•œ ë¬¸ì¥ë§Œ ì¸ì‹
        recognition.interimResults = false; // ìµœì¢… ê²°ê³¼ë§Œ

        // ìŒì„± ì¸ì‹ ì‹œì‘
        btnVoice.addEventListener('click', () => {
            statusEl.textContent = "ë“£ê³  ìˆìŠµë‹ˆë‹¤... ğŸ¤";
            btnVoice.style.backgroundColor = '#dc3545'; // ë…¹ìŒ ì¤‘ ìƒ‰ìƒ
            sqlResultEl.textContent = "";
            recognition.start();
        });

        // ìŒì„± ì¸ì‹ ê²°ê³¼ ì²˜ë¦¬
        recognition.onresult = (event) => {
            const text = event.results[0][0].transcript;
            statusEl.textContent = `ì¸ì‹ëœ í…ìŠ¤íŠ¸: "${text}"`;
            
            // ì¸ì‹ëœ í…ìŠ¤íŠ¸ë¥¼ ë°±ì—”ë“œë¡œ ì „ì†¡
            sendToBackend(text);
        };

        // ìŒì„± ì¸ì‹ ì¢…ë£Œ (ì •ìƒ/ì—ëŸ¬)
        recognition.onend = () => {
            btnVoice.style.backgroundColor = '#007bff'; // ì›ë˜ ìƒ‰ìƒ
        };

        recognition.onerror = (event) => {
            statusEl.textContent = `ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ${event.error}`;
        };
    }

    // --- 3. ë°±ì—”ë“œ API í˜¸ì¶œ (í•µì‹¬) ---
    async function sendToBackend(text) {
        statusEl.textContent = "ë°±ì—”ë“œì—ì„œ ë¶„ì„ ì¤‘... (ìµœëŒ€ 10ì´ˆ ì†Œìš”)";
        
        // ë°±ì—”ë“œ ì£¼ì†Œ (main.pyê°€ ì‹¤í–‰ ì¤‘ì¸ ê³³)
        const backendUrl = 'http://127.0.0.1:8000/analyze';

        try {
            const response = await fetch(backendUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ text: text })
            });

            const geojsonResult = await response.json();

            // ë°±ì—”ë“œì—ì„œ ì—ëŸ¬ê°€ ë°˜í™˜ëœ ê²½ìš°
            if (geojsonResult.error) {
                statusEl.textContent = "ë¶„ì„ ì˜¤ë¥˜ ë°œìƒ!";
                sqlResultEl.textContent = `[ì—ëŸ¬]\n${geojsonResult.error}\n\n[ìƒì„±ëœ ì¿¼ë¦¬]\n${geojsonResult.query || 'N/A'}`;
                updateMap({ type: 'FeatureCollection', features: [] }); // ì§€ë„ í´ë¦¬ì–´
            } 
            // ì •ìƒ ê²°ê³¼
            else {
                statusEl.textContent = `ë¶„ì„ ì™„ë£Œ! ${geojsonResult.features.length}ê°œ ê²°ê³¼ í‘œì‹œ.`;
                sqlResultEl.textContent = `[ë°±ì—”ë“œ ì •ë³´]\nLLMì´ ìƒì„±í•œ SQLì€ ë°±ì—”ë“œ í„°ë¯¸ë„ì„ í™•ì¸í•˜ì„¸ìš”.\n\n[ê²°ê³¼ ì†ì„± (ì²« ë²ˆì§¸)]\n${JSON.stringify(geojsonResult.features[0]?.properties || 'ê²°ê³¼ ì—†ìŒ', null, 2)}`;
                
                // ì§€ë„ ì—…ë°ì´íŠ¸
                updateMap(geojsonResult);
            }

        } catch (error) {
            statusEl.textContent = "ë°±ì—”ë“œ ì„œë²„ ì—°ê²° ì‹¤íŒ¨!";
            sqlResultEl.textContent = `ë°±ì—”ë“œ(FastAPI) ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.\n(Error: ${error.message})`;
        }
    }

    // --- 4. ì§€ë„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
    function updateMap(geojson) {
        // ê¸°ì¡´ ì†ŒìŠ¤ ë°ì´í„° ì—…ë°ì´íŠ¸
        map.getSource('analysis-results').setData(geojson);
        
        // ë°ì´í„°ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì§€ë„ ì´ë™
        if (geojson.features.length > 0) {
            // (ê°„ë‹¨í•˜ê²Œ ì²« ë²ˆì§¸ í”¼ì²˜ì˜ ì¤‘ì‹¬ìœ¼ë¡œ ì´ë™)
            const coordinates = geojson.features[0].geometry.coordinates;
            map.flyTo({
                center: coordinates,
                zoom: 16
            });
        }
    }
</script>

</body>
</html>