<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>ìŒì„±/í…ìŠ¤íŠ¸ GIS ëŒ€ì‹œë³´ë“œ</title>
    
    <script src='https://unpkg.com/maplibre-gl@4.1.3/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@4.1.3/dist/maplibre-gl.css' rel='stylesheet' />
    
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10;
            width: 300px;
            max-height: 90vh; /* [NEW] ë†’ì´ ì œí•œ */
            overflow-y: auto; /* [NEW] ì»¨íŠ¸ë¡¤ ìŠ¤í¬ë¡¤ */
        }
        
        #status {
            margin-top: 15px;
            font-size: 14px;
            color: #555;
            min-height: 40px;
        }

        /* [NEW] í…ìŠ¤íŠ¸ ë‹µë³€ UI */
        #answerBox {
            margin-top: 15px;
            padding: 10px;
            background: #f4f4f4;
            border-radius: 5px;
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
        }
        
        #sqlResult {
            /* (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ë™ì¼) */
            position: absolute; bottom: 20px; left: 20px;
            background: rgba(0,0,0,0.7); color: white; padding: 10px;
            border-radius: 5px; z-index: 10; font-family: monospace;
            max-width: 500px; max-height: 200px; overflow-y: auto;
        }
    </style>
</head>
<body>

<div id='map'></div>

<div id="controls">
    <h3>ìŒì„± ëª…ë ¹</h3>
    <button id="btnVoice" disabled>ğŸ™ï¸ (ì§€ë„ ë¡œë”© ì¤‘...)</button>
    <div id="status">ì§€ë„ ë¡œë”© ì¤‘...</div>

    <hr style="margin: 20px 0;">
    <h3>í…ìŠ¤íŠ¸ ëª…ë ¹</h3>
    <input type="text" id="textInput" placeholder="ì§€ë„ ë¡œë”© ì¤‘..." disabled>
    <button id="btnSubmitText" disabled>ë¶„ì„ ì‹¤í–‰</button>

    <div id="answerBox">
        <h4>AI ë‹µë³€:</h4>
        <p id="answerText"></p>
    </div>
    </div>

<pre id="sqlResult"></pre>


<script>
    // --- 1. UI ìš”ì†Œ ë¯¸ë¦¬ ê°€ì ¸ì˜¤ê¸° ---
    const btnVoice = document.getElementById('btnVoice');
    const statusEl = document.getElementById('status');
    const sqlResultEl = document.getElementById('sqlResult');
    const textInput = document.getElementById('textInput');
    const btnSubmitText = document.getElementById('btnSubmitText');
    
    // [NEW] í…ìŠ¤íŠ¸ ë‹µë³€ UI
    const answerBox = document.getElementById('answerBox');
    const answerText = document.getElementById('answerText');
    
    const speechRecognitionAvailable = window.SpeechRecognition || window.webkitSpeechRecognition;

    // --- 2. MapLibre ì§€ë„ ì´ˆê¸°í™” ---
    const map = new maplibregl.Map({
        container: 'map',
        style: 'https://api.maptiler.com/maps/streets-v2/style.json?key=ov5U6wIwpS3kTZHbW0wk',
        center: [126.9380, 37.6000], 
        zoom: 15
    });

    // --- 3. ì§€ë„ ë¡œë”© ì™„ë£Œ ì´ë²¤íŠ¸ ---
    map.on('load', () => {
        map.addSource('analysis-results', {
            type: 'geojson',
            data: { type: 'FeatureCollection', features: [] }
        });
        
        // --- [ìˆ˜ì •] ë°ì´í„° ê¸°ë°˜ ìŠ¤íƒ€ì¼ë§ ë ˆì´ì–´ ---
        map.addLayer({
            id: 'results-points',
            type: 'circle',
            source: 'analysis-results',
            paint: {
                // [NEW] data_type ì†ì„± ê°’ì— ë”°ë¼ ìƒ‰ìƒ ë³€ê²½
                'circle-color': [
                    'match',
                    ['get', 'data_type'], // GeoJSONì˜ properties.data_type ê°’ì„ ê°€ì ¸ì˜´
                    'building', '#FF4136',  // 'building'ì´ë©´ ë¹¨ê°„ìƒ‰
                    'station', '#0074D9',   // 'station'ì´ë©´ íŒŒë€ìƒ‰
                    '#AAAAAA'               // ê·¸ ì™¸ì—ëŠ” íšŒìƒ‰
                ],
                'circle-radius': 8,
                'circle-stroke-width': 2,
                'circle-stroke-color': '#FFFFFF'
            }
        });

        // UI í™œì„±í™”
        statusEl.textContent = "ì§€ë„ ë¡œë”© ì™„ë£Œ. ëª…ë ¹ ëŒ€ê¸° ì¤‘...";
        if (speechRecognitionAvailable) {
            btnVoice.disabled = false;
            btnVoice.textContent = "ğŸ™ï¸ (ëˆŒëŸ¬ì„œ ë§í•˜ê¸°)";
        } else {
            statusEl.textContent = "ì˜¤ë¥˜: ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
            btnVoice.textContent = "ğŸ™ï¸ (ìŒì„±ì¸ì‹ ë¶ˆê°€)";
        }
        textInput.disabled = false;
        textInput.placeholder = "ì˜ˆ: ë…¹ë²ˆì—­ 500ë¯¸í„° ì´ë‚´ ê±´ë¬¼";
        btnSubmitText.disabled = false;
    });

    // --- 4. ìŒì„± ì¸ì‹ ì„¤ì • (ê¸°ì¡´ê³¼ ë™ì¼) ---
    // (ìƒëµ - ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)

    // --- 5. í…ìŠ¤íŠ¸ ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ê¸°ì¡´ê³¼ ë™ì¼) ---
    btnSubmitText.addEventListener('click', submitText);
    textInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            submitText();
        }
    });

    function submitText() {
        const text = textInput.value;
        if (text.trim() === "") { return; }
        statusEl.textContent = `ì…ë ¥ëœ í…ìŠ¤íŠ¸: "${text}"`;
        sqlResultEl.textContent = "";
        answerBox.style.display = "none"; // ë‹µë³€ ìƒì ì´ˆê¸°í™”
        
        sendToBackend(text);
    }

    // --- 6. [ìˆ˜ì •] ë°±ì—”ë“œ API í˜¸ì¶œ (ë¼ìš°íŒ…) ---
    async function sendToBackend(text) {
        statusEl.textContent = "ë°±ì—”ë“œì—ì„œ ë¶„ì„ ì¤‘...";
        const backendUrl = 'http://127.0.0.1:8000/analyze';

        try {
            const response = await fetch(backendUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text })
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const result = await response.json();

            // --- [NEW] ë°±ì—”ë“œ ì‘ë‹µ ë¼ìš°íŒ… ---
            
            // 1. í…ìŠ¤íŠ¸ ë‹µë³€ì´ ì˜¨ ê²½ìš° (GENERAL_ANSWER)
            if (result.answer_text) {
                statusEl.textContent = "AI ë‹µë³€ì„ ìˆ˜ì‹ í–ˆìŠµë‹ˆë‹¤.";
                answerText.textContent = result.answer_text;
                answerBox.style.display = "block"; // ë‹µë³€ ìƒì ë³´ì´ê¸°
                updateMap({ type: 'FeatureCollection', features: [] }); // ì§€ë„ ì§€ìš°ê¸°
                sqlResultEl.textContent = "[ì¼ë°˜ í…ìŠ¤íŠ¸ ë‹µë³€]";
            
            // 2. GeoJSON ë°ì´í„°ê°€ ì˜¨ ê²½ìš° (SPATIAL_QUERY)
            } else if (result.type === "FeatureCollection") {
                statusEl.textContent = `ë¶„ì„ ì™„ë£Œ! ${result.features.length}ê°œ ê²°ê³¼ í‘œì‹œ.`;
                sqlResultEl.textContent = `[ë°±ì—”ë“œ ì •ë³´]\nLLMì´ ìƒì„±í•œ SQLì€ ë°±ì—”ë“œ í„°ë¯¸ë„ì„ í™•ì¸í•˜ì„¸ìš”.`;
                updateMap(result); // ì§€ë„ ì—…ë°ì´íŠ¸
                answerBox.style.display = "none"; // ë‹µë³€ ìƒì ìˆ¨ê¸°ê¸°

            // 3. ì—ëŸ¬ê°€ ì˜¨ ê²½ìš°
            } else if (result.error) {
                statusEl.textContent = "ë¶„ì„ ì˜¤ë¥˜ ë°œìƒ!";
                sqlResultEl.textContent = `[ë°±ì—”ë“œ ì—ëŸ¬]\n${result.error}\n\n[ìƒì„±ëœ ì¿¼ë¦¬]\n${result.query || 'N/A'}`;
                updateMap({ type: 'FeatureCollection', features: [] });
            
            // 4. ì•Œ ìˆ˜ ì—†ëŠ” í˜•ì‹
            } else {
                throw new Error("ì•Œ ìˆ˜ ì—†ëŠ” ë°±ì—”ë“œ ì‘ë‹µ í˜•ì‹ì…ë‹ˆë‹¤.");
            }
            // --- ë¼ìš°íŒ… ë ---

        } catch (error) {
            console.error("Fetch Error:", error);
            statusEl.textContent = "ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ ë°œìƒ!";
            sqlResultEl.textContent = `(Error: ${error.message})\në°±ì—”ë“œ ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.`;
        }
    }

    // --- 7. ì§€ë„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ê¸°ì¡´ê³¼ ë™ì¼) ---
    function updateMap(geojson) {
        try {
            map.getSource('analysis-results').setData(geojson);
            
            if (geojson.features.length > 0) {
                // [NEW] FitBoundsë¡œ ëª¨ë“  í”¼ì²˜ê°€ ë³´ì´ë„ë¡ ì¤Œ
                const bounds = new maplibregl.LngLatBounds();
                geojson.features.forEach(feature => {
                    bounds.extend(feature.geometry.coordinates);
                });
                map.fitBounds(bounds, { padding: 100 }); // 100px ì—¬ë°±
            }
        } catch (error) {
            console.error("Map update error:", error);
            statusEl.textContent = "ì§€ë„ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.";
        }
    }
</script>

<script>
    if (speechRecognitionAvailable) {
        const recognition = new SpeechRecognition();
        recognition.lang = 'ko-KR';
        recognition.continuous = false;
        recognition.interimResults = false;
        btnVoice.addEventListener('click', () => {
            statusEl.textContent = "ë“£ê³  ìˆìŠµë‹ˆë‹¤... ğŸ¤";
            btnVoice.style.backgroundColor = '#dc3545';
            sqlResultEl.textContent = "";
            answerBox.style.display = "none"; // ë‹µë³€ ìƒì ì´ˆê¸°í™”
            recognition.start();
        });
        recognition.onresult = (event) => {
            const text = event.results[0][0].transcript;
            statusEl.textContent = `ì¸ì‹ëœ í…ìŠ¤íŠ¸: "${text}"`;
            sendToBackend(text);
        };
        recognition.onend = () => {
            btnVoice.style.backgroundColor = '#007bff';
        };
        recognition.onerror = (event) => {
            statusEl.textContent = `ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ${event.error}`;
        };
    }
</script>

</body>
</html>