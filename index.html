<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>GeoAI ëŒ€ì‹œë³´ë“œ</title>
    
    <script src='https://unpkg.com/maplibre-gl@4.1.3/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@4.1.3/dist/maplibre-gl.css' rel='stylesheet' />
    
    <style>
        /* (ê¸°ì¡´ CSSì™€ ë™ì¼) */
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #controls {
            position: absolute; top: 20px; left: 20px; background: white;
            padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10; width: 300px; max-height: 90vh; overflow-y: auto;
            transition: transform 0.3s ease; 
        }

        #infoContainer {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 340px; /* 300px (íŒ¨ë„) + 40px (íŒ¨ë”©) */
            z-index: 10;
            transition: transform 0.3s ease;
            transform: translateX(0); /* ê¸°ë³¸ ìƒíƒœ: ë³´ì„ */
        }
        
        #infoContainer.closed {
            transform: translateX(340px); 
        }

        #infoPanel {
            width: 300px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 90vh;
            overflow-y: auto;
            float: right; /* ì»¨í…Œì´ë„ˆì˜ ì˜¤ë¥¸ìª½ì— ë¶™ì„ */
        }

        #infoToggleBtn {
            position: absolute;
            top: 0;
            left: 0; /* ì»¨í…Œì´ë„ˆì˜ ì™¼ìª½ì— ë¶™ì„ */
            width: 40px;
            height: 40px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 8px 0 0 8px; /* ì™¼ìª½ë§Œ ë‘¥ê¸€ê²Œ */
            font-size: 16px;
            font-weight: bold;
            box-shadow: -2px 2px 10px rgba(0,0,0,0.1);
        }

        #status {
            margin-top: 15px; font-size: 14px; color: #555; min-height: 40px;
        }
        #textInput {
            width: 100%; height: 60px; padding: 10px; font-size: 14px;
            border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; 
            margin-bottom: 10px; resize: vertical; font-family: sans-serif;
        }
        #style-switcher { margin-bottom: 10px; }
        #style-switcher h4 { margin: 0 0 5px 0; }
        #mapStyleSelect {
            width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ccc;
            border-radius: 5px; background-color: white;
        }
        #answerBox {
            margin-top: 15px; padding: 10px; background: #f4f4f4;
            border-radius: 5px; display: none;
        }
        #sqlResult {
            position: absolute; bottom: 20px; left: 20px;
            background: rgba(0,0,0,0.7); color: white; padding: 10px;
            border-radius: 5px; z-index: 10; font-family: monospace;
            max-width: 500px; max-height: 200px; overflow-y: auto;
        }
        .maplibregl-popup-content {
            padding: 10px; background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 1px 5px rgba(0,0,0,0.2); border-radius: 5px; font-size: 13px;
        }
        .maplibregl-popup-content strong { color: #333; }
    </style>
</head>
<body>

<div id='map'></div>

<div id="controls">
    <div id="style-switcher">
        <h4>ë°°ê²½ì§€ë„ ì„ íƒ</h4>
        <select id="mapStyleSelect">
            <option value="streets-v2" selected>Streets (ê¸°ë³¸)</option>
            <option value="streets-v2-dark">Streets (Dark)</option>
            <option value="satellite">Satellite (ìœ„ì„±)</option>
            <option value="hybrid">Hybrid (ìœ„ì„± + ë¼ë²¨)</option>
            <option value="topo-v2">Topo (ì§€í˜•)</option>
            <option value="basic-v2">Basic (ë‹¨ìˆœ)</option>
        </select>
    </div>
    <hr style="margin: 20px 0;">
    <h3>ìŒì„± ëª…ë ¹</h3>
    <button id="btnVoice" disabled>ğŸ™ï¸ (ì§€ë„ ë¡œë”© ì¤‘...)</button>
    <div id="status">ì§€ë„ ë¡œë”© ì¤‘...</div>
    <hr style="margin: 20px 0;">
    <h3>í…ìŠ¤íŠ¸ ëª…ë ¹</h3>
    <textarea id="textInput" placeholder="ì§€ë„ ë¡œë”© ì¤‘..." disabled></textarea>
    <button id="btnSubmitText" disabled>ë¶„ì„ ì‹¤í–‰</button>
    <div id="answerBox">
        <h4>AI ë‹µë³€:</h4>
        <p id="answerText"></p>
    </div>
</div>

<div id="infoContainer">
    <div id="infoPanel">
        <p style="font-size: 14px;">ìŒì„±/í…ìŠ¤íŠ¸ë¡œ ì§€ë„ ê²€ìƒ‰ ë° ê³µê°„ë¶„ì„ì„ í•  ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤</p>
        
        <h4>1. ì¼ë°˜</h4>
        <ul>
            <li>ë„¤ê°€ ì§€ë„ë¡œ í•  ìˆ˜ ìˆëŠ” ì˜ˆë¬¸ì„ ë³´ì—¬ì¤˜</li>
            <li>ë„¤ê°€ ê°€ì§„ ë°ì´í„° ëª©ë¡ì„ ë³´ì—¬ì¤˜</li>
        </ul>

        <h4>2. ì§€ë„ ê²€ìƒ‰</h4>
        <ul>
            <li>ëŒ€ë¦¼ì—­ ìœ„ì¹˜ë¥¼ ë³´ì—¬ì¤˜</li>
        </ul>

        <h4>3. ì§€ë„ ì œì–´</h4>
        <ul>
            <li>ì§€ë„ ì¶•ì†Œí•´ì¤˜</li>
            <li>ì§€ë„ë¥¼ ì™¼ìª½ìœ¼ë¡œ ì´ë™í•´ì¤˜</li>
            <li>ìœ„ì„± ì§€ë„ë¡œ ë°”ê¿”ì¤˜</li>
            <li>ì§€ë„ë¥¼ 3D ë·°ë¡œ ë³´ì—¬ì¤˜</li>
        </ul>

        <h4>4. ê³µê°„ ë¶„ì„</h4>
        <ul>
            <li>ëŒ€ë¦¼ì—­ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ ëª…ì¸ë§Œë‘ ìœ„ì¹˜ë¥¼ ë³´ì—¬ì¤˜</li>
            <li>ëŒ€ë¦¼ì—­ì—ì„œ 100ë¯¸í„° ë°˜ê²½ ì˜ì—­ì„ ê·¸ë ¤ì„œ ë³´ì—¬ì¤˜</li>
            <li>ëŒ€ë¦¼ì—­ ë°˜ê²½ 250ë¯¸í„° ë‚´ì— ìˆëŠ” ë¶„ì‹ì§‘ì„ ì°¾ì•„ì¤˜</li>
            <li>ëŒ€ë¦¼ì—­ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ ê±´ë¬¼ 5ê°œë¥¼ ì°¾ì•„ì¤˜</li>
            <li>ëŒ€ë¦¼ì—­ì—ì„œ 100ë¯¸í„° ì´ë‚´ì˜ ê±´ë¬¼ ì¤‘ì—ì„œ 50ë…„ ì´ìƒëœ ê±´ë¬¼ì„ ì°¾ì•„ì„œ ê²½ê³„ ì˜ì—­ì„ ê·¸ë ¤ì¤˜</li>
        </ul>
    </div>
    <button id="infoToggleBtn">&gt;</button> 
</div>


<pre id="sqlResult"></pre>


<script>
    // --- 1. UI ìš”ì†Œ ---
    const btnVoice = document.getElementById('btnVoice');
    const statusEl = document.getElementById('status');
    const sqlResultEl = document.getElementById('sqlResult');
    const textInput = document.getElementById('textInput');
    const btnSubmitText = document.getElementById('btnSubmitText');
    const answerBox = document.getElementById('answerBox');
    const answerText = document.getElementById('answerText');
    const styleSelect = document.getElementById('mapStyleSelect');
    const speechRecognitionAvailable = window.SpeechRecognition || window.webkitSpeechRecognition;
    const infoContainer = document.getElementById('infoContainer');
    const infoToggleBtn = document.getElementById('infoToggleBtn');
    const controlsPanel = document.getElementById('controls'); 

    // --- 2. MapTiler í‚¤ ë° ì§€ë„ ì´ˆê¸°í™” ---
    const mapTilerKey = 't2NOj07Xp2ihKwSzIP14'; 
    const defaultStyle = 'streets-v2';
    const baseCoords = [126.888018, 37.494571]; 

    const map = new maplibregl.Map({
        container: 'map',
        style: `https://api.maptiler.com/maps/${defaultStyle}/style.json?key=${mapTilerKey}`,
        center: baseCoords, 
        zoom: 15
    });

    // --- 3. ë¶„ì„ ë ˆì´ì–´ ì¶”ê°€ í•¨ìˆ˜ (ë™ì¼) ---
    function setupAnalysisLayers() {
        if (!map.getSource('analysis-results')) {
            map.addSource('analysis-results', {
                type: 'geojson',
                data: { type: 'FeatureCollection', features: [] }
            });
        }
        
        // 1. í´ë¦¬ê³¤(ì˜ì—­) ë ˆì´ì–´
        if (!map.getLayer('results-polygons')) {
            map.addLayer({
                id: 'results-polygons', type: 'fill', source: 'analysis-results',
                paint: { 'fill-color':'#0074D9', 'fill-opacity': 0.5 },
                filter: ['==', ['geometry-type'], 'Polygon']
            });
        }

        // 2. ì (í¬ì¸íŠ¸) ë ˆì´ì–´ (ë‹¨ê³„êµ¬ë¶„ë„ í¬í•¨)
        if (!map.getLayer('results-points')) {
            map.addLayer({
                id: 'results-points', type: 'circle', source: 'analysis-results',
                paint: {
                    'circle-color': [
                        'match', ['get', 'data_type'],
                        'building', '#FF4136',  
                        'station', '#0074D9',
                        'subway_station', '#0074D9',
                        '1980ë…„ ì´ì „', '#FFFF00', 
                        '1980ë…„ëŒ€', '#FFC300', 
                        '1990ë…„ëŒ€', '#FF5733', 
                        '2000ë…„ëŒ€', '#C70039', 
                        '2010ë…„ëŒ€', '#900C3F', 
                        '2020ë…„ ì´í›„', '#581845',
                        '#AAAAAA'
                    ],
                    'circle-radius': 8, 'circle-stroke-width': 2, 'circle-stroke-color': '#FFFFFF'
                },
                filter: ['==', ['geometry-type'], 'Point']
            });
        }
        
        // 3. íŒì—… ë° ì»¤ì„œ ì´ë²¤íŠ¸ (ë™ì¼)
        map.on('click', (e) => {
            const layersToQuery = ['results-points', 'results-polygons'];
            if (!map.getLayer('results-points') || !map.getLayer('results-polygons')) {
                return; 
            }
            const features = map.queryRenderedFeatures(e.point, { layers: layersToQuery });
            if (!features.length) {
                return; 
            }
            let pointFeature = features.find(f => f.layer.id === 'results-points');
            let featureToShow = pointFeature ? pointFeature : features[0]; 
            const properties = featureToShow.properties;
            let htmlContent = "<div>";
            for (const key in properties) {
                if (key !== 'data_type') {
                    htmlContent += `<strong>${key}:</strong> ${properties[key]}<br>`;
                }
            }
            htmlContent += "</div>";
            new maplibregl.Popup().setLngLat(e.lngLat).setHTML(htmlContent).addTo(map);
        });

        map.on('mousemove', (e) => {
            const layersToQuery = ['results-points', 'results-polygons'];
            if (!map.getLayer('results-points') || !map.getLayer('results-polygons')) {
                map.getCanvas().style.cursor = ''; 
                return; 
            }
            const features = map.queryRenderedFeatures(e.point, { layers: layersToQuery });
            map.getCanvas().style.cursor = (features.length > 0) ? 'pointer' : '';
        });
    }

    // --- 4. ì§€ë„ ë¡œë”© ì™„ë£Œ ì´ë²¤íŠ¸ (ë™ì¼) ---
    map.on('load', () => {
        setupAnalysisLayers();
        statusEl.textContent = "ì§€ë„ ë¡œë”© ì™„ë£Œ. ëª…ë ¹ ëŒ€ê¸° ì¤‘...";
        if (speechRecognitionAvailable) {
            btnVoice.disabled = false;
            btnVoice.textContent = "ğŸ™ï¸ (ëˆŒëŸ¬ì„œ ë§í•˜ê¸°)";
        }
        textInput.disabled = false;
        textInput.placeholder = "ì˜ˆ: ë…¹ë²ˆì—­ 500ë¯¸í„° ì´ë‚´ ê±´ë¬¼\n(Enterë¡œë„ ì‹¤í–‰ ê°€ëŠ¥)";
        btnSubmitText.disabled = false;
    });

    // --- 5. ë°°ê²½ì§€ë„ ë³€ê²½ ì´ë²¤íŠ¸ (ë™ì¼) ---
    styleSelect.addEventListener('change', (e) => {
        const styleId = e.target.value;
        const newStyleUrl = `https://api.maptiler.com/maps/${styleId}/style.json?key=${mapTilerKey}`;
        map.setStyle(newStyleUrl);
    });

    map.on('style.load', () => {
        setupAnalysisLayers();
    });

    // --- 6. ì˜¤ë¥¸ìª½ íŒ¨ë„ í† ê¸€ ì´ë²¤íŠ¸ (ë™ì¼) ---
    infoToggleBtn.addEventListener('click', () => {
        infoContainer.classList.toggle('closed');
        if (infoContainer.classList.contains('closed')) {
            infoToggleBtn.textContent = '<'; // ë‹«í˜”ì„ ë•Œ
        } else {
            infoToggleBtn.textContent = '>'; // ì—´ë ¸ì„ ë•Œ (default)
        }
    });

    // --- 7. í…ìŠ¤íŠ¸ ì…ë ¥ (ë™ì¼) ---
    btnSubmitText.addEventListener('click', submitText);
    textInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault(); 
            submitText();
        }
    });

    function submitText() {
        const text = textInput.value.trim();
        if (text === "") { return; }
        statusEl.textContent = `ì…ë ¥ëœ í…ìŠ¤íŠ¸: "${text}"`;
        sqlResultEl.textContent = "";
        answerBox.style.display = "none"; 
        sendToBackend(text);
    }

    // --- 8. ë°±ì—”ë“œ API í˜¸ì¶œ (ë™ì¼) ---
    async function sendToBackend(text) {
        statusEl.textContent = "ë°±ì—”ë“œì—ì„œ ë¶„ì„ ì¤‘...";
        const backendUrl = 'https://ai-sql-map-backend.onrender.com/analyze'; 

        try {
            const response = await fetch(backendUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text })
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            
            if (result.type === "CLIENT_COMMAND") {
                statusEl.textContent = "ì§€ë„ ì œì–´ ëª…ë ¹ ìˆ˜ì‹ .";
                sqlResultEl.textContent = `[í´ë¼ì´ì–¸íŠ¸ ëª…ë ¹]\n${result.content}`;
                handleClientCommand(result.content); 

            } else if (result.type === "FeatureCollection") {
                statusEl.textContent = `ë¶„ì„ ì™„ë£Œ! ${result.features.length}ê°œ ê²°ê³¼ í‘œì‹œ.`;
                sqlResultEl.textContent = `[ë°±ì—”ë“œ ì •ë³´]\nLLMì´ ìƒì„±í•œ SQLì€ ë°±ì—”ë“œ í„°ë¯¸ë„ì„ í™•ì¸í•˜ì„¸ìš”.`;
                updateMap(result);
                answerBox.style.display = "none";

            } else if (result.answer_text) {
                statusEl.textContent = "AI ë‹µë³€ì„ ìˆ˜ì‹ í–ˆìŠµë‹ˆë‹¤.";
                answerText.textContent = result.answer_text;
                answerBox.style.display = "block";
                updateMap({ type: 'FeatureCollection', features: [] });
                sqlResultEl.textContent = "[ì¼ë°˜ í…ìŠ¤íŠ¸ ë‹µë³€]";

            } else if (result.error) {
                statusEl.textContent = "ë¶„ì„ ì˜¤ë¥˜ ë°œìƒ!";
                sqlResultEl.textContent = `[ë°±ì—”ë“œ ì—ëŸ¬]\n${result.error}\n\n[ìƒì„±ëœ ì¿¼ë¦¬]\n${result.query || 'N/A'}`;
                updateMap({ type: 'FeatureCollection', features: [] });

            } else {
                throw new Error("ì•Œ ìˆ˜ ì—†ëŠ” ë°±ì—”ë“œ ì‘ë‹µ í˜•ì‹ì…ë‹ˆë‹¤.");
            }

        } catch (error) {
            console.error("Fetch Error:", error);
            statusEl.textContent = "ë°±ì—”ë“œ ì„œë²„ ì—°ê²° ì‹¤íŒ¨!";
            sqlResultEl.textContent = `ë°±ì—”ë“œ ì„œë²„(${backendUrl}) ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n(Error: ${error.message})\n\nRender.com ì„œë²„ê°€ ì ìê¸°(cold start) ìƒíƒœì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 30ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„í•´ ë³´ì„¸ìš”.`;
        }
    }

    // --- [ìˆ˜ì •] 9. í´ë¼ì´ì–¸íŠ¸ ëª…ë ¹ ì²˜ë¦¬ í•¨ìˆ˜ (3D/Pitch ê¸°ëŠ¥ ì¶”ê°€) ---
    function handleClientCommand(command) {
        const panAmount = 100; // 100px
        
        // ìŠ¤íƒ€ì¼ ë³€ê²½ í—¬í¼ í•¨ìˆ˜
        function changeMapStyle(styleValue) {
            styleSelect.value = styleValue;
            styleSelect.dispatchEvent(new Event('change'));
        }
        
        switch (command) {
            // ì§€ë„ ì¡°ì‘
            case 'ZOOM_IN':
                map.zoomIn({ duration: 300 });
                break;
            case 'ZOOM_OUT':
                map.zoomOut({ duration: 300 });
                break;
            case 'PAN_TO_BASE':
                map.easeTo({ center: baseCoords, zoom: 15, pitch: 0, bearing: 0 }); // [ìˆ˜ì •] 2Dë¡œ ë¦¬ì…‹
                break;
            // ì§€ë„ ì´ë™
            case 'PAN_EAST':
                map.panBy([panAmount, 0], { duration: 300 });
                break;
            case 'PAN_WEST':
                map.panBy([-panAmount, 0], { duration: 300 });
                break;
            case 'PAN_NORTH':
                map.panBy([0, -panAmount], { duration: 300 });
                break;
            case 'PAN_SOUTH':
                map.panBy([0, panAmount], { duration: 300 });
                break;

            // [NEW] ì‹œì  ë³€ê²½ (Pitch)
            case 'SET_PITCH_3D':
                map.easeTo({ pitch: 60, duration: 1000 }); // 60ë„ ê¸°ìš¸ì´ê¸°
                break;
            case 'SET_PITCH_2D':
                map.easeTo({ pitch: 0, duration: 1000 }); // 0ë„ (í‰ë©´)
                break;
            // [NEW] ë
            
            // ì§€ë„ ìŠ¤íƒ€ì¼
            case 'SET_STYLE_STREETS':
                changeMapStyle('streets-v2');
                break;
            case 'SET_STYLE_DARK':
                changeMapStyle('streets-v2-dark');
                break;
            case 'SET_STYLE_SATELLITE':
                changeMapStyle('satellite');
                break;
            case 'SET_STYLE_HYBRID':
                changeMapStyle('hybrid');
                break;
            case 'SET_STYLE_TOPO':
                changeMapStyle('topo-v2');
                break;
            case 'SET_STYLE_BASIC':
                changeMapStyle('basic-v2');
                break;

            default:
                console.warn("Unknown client command:", command);
                statusEl.textContent = "ì•Œ ìˆ˜ ì—†ëŠ” ì§€ë„ ëª…ë ¹ì…ë‹ˆë‹¤.";
        }
    }

    // --- 10. ì§€ë„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ë™ì¼) ---
    function updateMap(geojson) {
        try {
            const source = map.getSource('analysis-results');
            if (source) {
                source.setData(geojson);
            }
            if (geojson.features.length > 0) {
                const bounds = new maplibregl.LngLatBounds();
                
                geojson.features.forEach(feature => {
                    if (feature.geometry.type === 'Point') {
                        bounds.extend(feature.geometry.coordinates);
                    } else if (feature.geometry.type === 'Polygon' && feature.geometry.coordinates) {
                        feature.geometry.coordinates.forEach(ring => {
                            ring.forEach(coord => {
                                bounds.extend(coord);
                            });
                        });
                    }
                });

                if (geojson.features.length === 1 && geojson.features[0].geometry.type === 'Point') {
                     map.flyTo({ center: geojson.features[0].geometry.coordinates, zoom: 16 });
                } else {
                     map.fitBounds(bounds, { padding: 100 });
                }
            }
        } catch (error) {
            console.error("Map update error:", error);
            statusEl.textContent = "ì§€ë„ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.";
        }
    }
    
    // --- 11. ìŒì„± ì¸ì‹ (ë™ì¼) ---
    if (speechRecognitionAvailable) {
        const recognition = new SpeechRecognition();
        recognition.lang = 'ko-KR';
        recognition.continuous = false;
        recognition.interimResults = false;
        btnVoice.addEventListener('click', () => {
            statusEl.textContent = "ë“£ê³  ìˆìŠµë‹ˆë‹¤... ğŸ¤";
            btnVoice.style.backgroundColor = '#dc3545';
            sqlResultEl.textContent = "";
            answerBox.style.display = "none";
            recognition.start();
        });
        recognition.onresult = (event) => {
            const text = event.results[0][0].transcript;
            statusEl.textContent = `ì¸ì‹ëœ TĞµĞºÑÑ‚: "${text}"`;
            sendToBackend(text);
        };
        recognition.onend = () => {
            btnVoice.style.backgroundColor = '#007bff';
        };
        recognition.onerror = (event) => {
            statusEl.textContent = `ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ${event.error}`;
        };
    }
</script>

</body>
</html>