<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>ìŒì„±/í…ìŠ¤íŠ¸ GIS ëŒ€ì‹œë³´ë“œ</title>
    
    <script src='https://unpkg.com/maplibre-gl@4.1.3/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@4.1.3/dist/maplibre-gl.css' rel='stylesheet' />
    
    <style>
        /* (ê¸°ì¡´ CSSì™€ ë™ì¼) */
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #controls {
            position: absolute; top: 20px; left: 20px; background: white;
            padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10; width: 300px; max-height: 90vh; overflow-y: auto;
        }
        #status {
            margin-top: 15px; font-size: 14px; color: #555; min-height: 40px;
        }
        #textInput {
            width: 100%; height: 60px; padding: 10px; font-size: 14px;
            border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; 
            margin-bottom: 10px; resize: vertical; font-family: sans-serif;
        }
        #style-switcher { margin-bottom: 10px; }
        #style-switcher h4 { margin: 0 0 5px 0; }
        #mapStyleSelect {
            width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ccc;
            border-radius: 5px; background-color: white;
        }
        #answerBox {
            margin-top: 15px; padding: 10px; background: #f4f4f4;
            border-radius: 5px; display: none;
        }
        #sqlResult {
            position: absolute; bottom: 20px; left: 20px;
            background: rgba(0,0,0,0.7); color: white; padding: 10px;
            border-radius: 5px; z-index: 10; font-family: monospace;
            max-width: 500px; max-height: 200px; overflow-y: auto;
        }
        .maplibregl-popup-content {
            padding: 10px; background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 1px 5px rgba(0,0,0,0.2); border-radius: 5px; font-size: 13px;
        }
        .maplibregl-popup-content strong { color: #333; }
    </style>
</head>
<body>

<div id='map'></div>

<div id="controls">
    <div id="style-switcher">
        <h4>ë°°ê²½ì§€ë„ ì„ íƒ</h4>
        <select id="mapStyleSelect">
            <option value="streets-v2" selected>Streets (ê¸°ë³¸)</option>
            <option value="streets-v2-dark">Streets (Dark)</option>
            <option value="satellite">Satellite (ìœ„ì„±)</option>
            <option value="hybrid">Hybrid (ìœ„ì„± + ë¼ë²¨)</option>
            <option value="topo-v2">Topo (ì§€í˜•)</option>
            <option value="basic-v2">Basic (ë‹¨ìˆœ)</option>
        </select>
    </div>
    <hr style="margin: 20px 0;">
    <h3>ìŒì„± ëª…ë ¹</h3>
    <button id="btnVoice" disabled>ğŸ™ï¸ (ì§€ë„ ë¡œë”© ì¤‘...)</button>
    <div id="status">ì§€ë„ ë¡œë”© ì¤‘...</div>
    <hr style="margin: 20px 0;">
    <h3>í…ìŠ¤íŠ¸ ëª…ë ¹</h3>
    <textarea id="textInput" placeholder="ì§€ë„ ë¡œë”© ì¤‘..." disabled></textarea>
    <button id="btnSubmitText" disabled>ë¶„ì„ ì‹¤í–‰</button>
    <div id="answerBox">
        <h4>AI ë‹µë³€:</h4>
        <p id="answerText"></p>
    </div>
</div>

<pre id="sqlResult"></pre>


<script>
    // --- 1. UI ìš”ì†Œ (ë™ì¼) ---
    const btnVoice = document.getElementById('btnVoice');
    const statusEl = document.getElementById('status');
    const sqlResultEl = document.getElementById('sqlResult');
    const textInput = document.getElementById('textInput');
    const btnSubmitText = document.getElementById('btnSubmitText');
    const answerBox = document.getElementById('answerBox');
    const answerText = document.getElementById('answerText');
    const styleSelect = document.getElementById('mapStyleSelect');
    const speechRecognitionAvailable = window.SpeechRecognition || window.webkitSpeechRecognition;

    // --- 2. MapTiler í‚¤ ë° ì§€ë„ ì´ˆê¸°í™” ---
    const mapTilerKey = 't2NOj07Xp2ihKwSzIP14'; // ğŸ‘ˆ ì‚¬ìš©ìë‹˜ì´ ì…ë ¥í•˜ì‹  í‚¤
    const defaultStyle = 'streets-v2';

    const map = new maplibregl.Map({
        container: 'map',
        style: `https://api.maptiler.com/maps/${defaultStyle}/style.json?key=${mapTilerKey}`,
        center: [126.9380, 37.6000], 
        zoom: 15
    });

    // --- 3. ë¶„ì„ ë ˆì´ì–´ ì¶”ê°€ í•¨ìˆ˜ ---
    function setupAnalysisLayers() {
        if (!map.getSource('analysis-results')) {
            map.addSource('analysis-results', {
                type: 'geojson',
                data: { type: 'FeatureCollection', features: [] }
            });
        }
        
        // --- 1. í´ë¦¬ê³¤(ì˜ì—­) ë ˆì´ì–´ ---
        if (!map.getLayer('results-polygons')) {
            map.addLayer({
                id: 'results-polygons',
                type: 'fill',
                source: 'analysis-results',
                paint: {
                    'fill-color':'#0074D9', 
                    'fill-opacity': 0.5     
		},
                filter: ['==', ['geometry-type'], 'Polygon']
            });
        }

        // --- 2. ì (í¬ì¸íŠ¸) ë ˆì´ì–´ ---
        if (!map.getLayer('results-points')) {
            map.addLayer({
                id: 'results-points',
                type: 'circle', 
                source: 'analysis-results',
                paint: {
                    'circle-color': [
                        'match',
                        ['get', 'data_type'],
                        'building', '#FF4136',  
                        'station', '#0074D9',
                        'subway_station', '#0074D9',
                        '#AAAAAA'
                    ],
                    'circle-radius': 8,
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#FFFFFF'
                },
                filter: ['==', ['geometry-type'], 'Point']
            });
        }

        // --- 3. [ìˆ˜ì •] íŒì—… ë° ì»¤ì„œ ì´ë²¤íŠ¸ (queryRenderedFeatures ì‚¬ìš©) ---
        // (ê¸°ì¡´ map.on('click', clickableLayers, ...) ì½”ë“œ ì‚­ì œ)
        // (ê¸°ì¡´ map.on('mouseenter', ...) ì½”ë“œ ì‚­ì œ)
        // (ê¸°ì¡´ map.on('mouseleave', ...) ì½”ë“œ ì‚­ì œ)

        // [NEW] ë§µ ì „ì²´ì— ëŒ€í•œ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        map.on('click', (e) => {
            const layersToQuery = ['results-points', 'results-polygons'];
            // í´ë¦­í•œ ì§€ì (e.point)ì—ì„œ í”¼ì²˜ë“¤ì„ ì¿¼ë¦¬
            const features = map.queryRenderedFeatures(e.point, { layers: layersToQuery });

            if (!features.length) {
                return; // í´ë¦­í•œ ê³³ì— í”¼ì²˜ ì—†ìŒ
            }

            // [NEW] ì (point) í”¼ì²˜ë¥¼ ìš°ì„ ì ìœ¼ë¡œ ì°¾ìŒ
            let pointFeature = features.find(f => f.layer.id === 'results-points');
            // ì ì´ ìˆìœ¼ë©´ ì ì„, ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ í”¼ì²˜(í´ë¦¬ê³¤)ë¥¼ ì‚¬ìš©
            let featureToShow = pointFeature ? pointFeature : features[0]; 

            const properties = featureToShow.properties;
            let htmlContent = "<div>";
            for (const key in properties) {
                if (key !== 'data_type') {
                    htmlContent += `<strong>${key}:</strong> ${properties[key]}<br>`;
                }
            }
            htmlContent += "</div>";

            new maplibregl.Popup()
                .setLngLat(e.lngLat)
                .setHTML(htmlContent)
                .addTo(map);
        });

        // [NEW] ë§ˆìš°ìŠ¤ ì»¤ì„œ ë³€ê²½ì„ ìœ„í•œ mousemove ì´ë²¤íŠ¸
        map.on('mousemove', (e) => {
            const layersToQuery = ['results-points', 'results-polygons'];
            const features = map.queryRenderedFeatures(e.point, { layers: layersToQuery });

            // í”¼ì²˜ ìœ„ì— ìˆìœ¼ë©´ ì»¤ì„œ ë³€ê²½, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
            if (features.length > 0) {
                map.getCanvas().style.cursor = 'pointer';
            } else {
                map.getCanvas().style.cursor = '';
            }
        });
        // --- [ìˆ˜ì •] ë ---
    }

    // --- 4. ì§€ë„ ë¡œë”© ì™„ë£Œ ì´ë²¤íŠ¸ (ë™ì¼) ---
    map.on('load', () => {
        setupAnalysisLayers();
        statusEl.textContent = "ì§€ë„ ë¡œë”© ì™„ë£Œ. ëª…ë ¹ ëŒ€ê¸° ì¤‘...";
        if (speechRecognitionAvailable) {
            btnVoice.disabled = false;
            btnVoice.textContent = "ğŸ™ï¸ (ëˆŒëŸ¬ì„œ ë§í•˜ê¸°)";
        } else {
            statusEl.textContent = "ì˜¤ë¥˜: ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
            btnVoice.textContent = "ğŸ™ï¸ (ìŒì„±ì¸ì‹ ë¶ˆê°€)";
        }
        textInput.disabled = false;
        textInput.placeholder = "ì˜ˆ: ë…¹ë²ˆì—­ 500ë¯¸í„° ì´ë‚´ ê±´ë¬¼\n(Enterë¡œë„ ì‹¤í–‰ ê°€ëŠ¥)";
        btnSubmitText.disabled = false;
    });

    // --- 5. ë°°ê²½ì§€ë„ ë³€ê²½ ì´ë²¤íŠ¸ (ë™ì¼) ---
    styleSelect.addEventListener('change', (e) => {
        const styleId = e.target.value;
        const newStyleUrl = `https://api.maptiler.com/maps/${styleId}/style.json?key=${mapTilerKey}`;
        map.setStyle(newStyleUrl);
    });

    map.on('style.load', () => {
        setupAnalysisLayers();
    });

    // --- 6. í…ìŠ¤íŠ¸ ì…ë ¥ (ë™ì¼) ---
    btnSubmitText.addEventListener('click', submitText);
    textInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault(); 
            submitText();
        }
    });

    function submitText() {
        const text = textInput.value.trim();
        if (text === "") { return; }
        statusEl.textContent = `ì…ë ¥ëœ í…ìŠ¤íŠ¸: "${text}"`;
        sqlResultEl.textContent = "";
        answerBox.style.display = "none"; 
        sendToBackend(text);
    }

    // --- 7. ë°±ì—”ë“œ API í˜¸ì¶œ  ---
async function sendToBackend(text) {
        statusEl.textContent = "ë°±ì—”ë“œì—ì„œ ë¶„ì„ ì¤‘...";
        const backendUrl = '[http://127.0.0.1:8000/analyze](http://127.0.0.1:8000/analyze)'; 

        try {
            const response = await fetch(backendUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text })
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            
            // --- [NEW] ë°±ì—”ë“œ ì‘ë‹µ ë¼ìš°íŒ… ---
            if (result.type === "CLIENT_COMMAND") {
                statusEl.textContent = "ì§€ë„ ì œì–´ ëª…ë ¹ ìˆ˜ì‹ .";
                sqlResultEl.textContent = `[í´ë¼ì´ì–¸íŠ¸ ëª…ë ¹]\n${result.content}`;
                handleClientCommand(result.content); // [NEW] ìƒˆ í•¨ìˆ˜ í˜¸ì¶œ

            } else if (result.type === "SPATIAL_QUERY") {
                statusEl.textContent = `ë¶„ì„ ì™„ë£Œ! ${result.features.length}ê°œ ê²°ê³¼ í‘œì‹œ.`;
                sqlResultEl.textContent = `[ë°±ì—”ë“œ ì •ë³´]\nLLMì´ ìƒì„±í•œ SQLì€ ë°±ì—”ë“œ í„°ë¯¸ë„ì„ í™•ì¸í•˜ì„¸ìš”.`;
                updateMap(result);
                answerBox.style.display = "none";

            } else if (result.answer_text) {
                statusEl.textContent = "AI ë‹µë³€ì„ ìˆ˜ì‹ í–ˆìŠµë‹ˆë‹¤.";
                answerText.textContent = result.answer_text;
                answerBox.style.display = "block";
                updateMap({ type: 'FeatureCollection', features: [] });
                sqlResultEl.textContent = "[ì¼ë°˜ í…ìŠ¤íŠ¸ ë‹µë³€]";

            } else if (result.error) {
                statusEl.textContent = "ë¶„ì„ ì˜¤ë¥˜ ë°œìƒ!";
                sqlResultEl.textContent = `[ë°±ì—”ë“œ ì—ëŸ¬]\n${result.error}\n\n[ìƒì„±ëœ ì¿¼ë¦¬]\n${result.query || 'N/A'}`;
                updateMap({ type: 'FeatureCollection', features: [] });

            } else {
                throw new Error("ì•Œ ìˆ˜ ì—†ëŠ” ë°±ì—”ë“œ ì‘ë‹µ í˜•ì‹ì…ë‹ˆë‹¤.");
            }

        } catch (error) {
            console.error("Fetch Error:", error);
            statusEl.textContent = "ë°±ì—”ë“œ ì„œë²„ ì—°ê²° ì‹¤íŒ¨!";
            sqlResultEl.textContent = `ë¡œì»¬ ë°±ì—”ë“œ(main.py)ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.\n(Error: ${error.message})`;
        }
    }

    // --- 8. [NEW] í´ë¼ì´ì–¸íŠ¸ ëª…ë ¹ ì²˜ë¦¬ í•¨ìˆ˜ ---
    function handleClientCommand(command) {
        switch (command) {
            case 'ZOOM_IN':
                map.zoomIn({ duration: 300 });
                break;
            case 'ZOOM_OUT':
                map.zoomOut({ duration: 300 });
                break;
            case 'PAN_TO_BASE':
                map.flyTo({ center: baseCoords, zoom: 15 });
                break;
            case 'SET_STYLE_SATELLITE':
                styleSelect.value = 'satellite';
                styleSelect.dispatchEvent(new Event('change')); // ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì´ë²¤íŠ¸ ê°•ì œ ì‹¤í–‰
                break;
            case 'SET_STYLE_STREETS':
                styleSelect.value = 'streets-v2';
                styleSelect.dispatchEvent(new Event('change')); // ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì´ë²¤íŠ¸ ê°•ì œ ì‹¤í–‰
                break;
            default:
                console.warn("Unknown client command:", command);
                statusEl.textContent = "ì•Œ ìˆ˜ ì—†ëŠ” ì§€ë„ ëª…ë ¹ì…ë‹ˆë‹¤.";
        }
    }

    // --- ì§€ë„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜  ---
    function updateMap(geojson) {
        try {
            const source = map.getSource('analysis-results');
            if (source) {
                source.setData(geojson);
            }
            if (geojson.features.length > 0) {
                const bounds = new maplibregl.LngLatBounds();
                
                geojson.features.forEach(feature => {
                    if (feature.geometry.type === 'Point') {
                        bounds.extend(feature.geometry.coordinates);
                    } else if (feature.geometry.type === 'Polygon') {
                        feature.geometry.coordinates[0].forEach(coord => {
                            bounds.extend(coord);
                        });
                    }
                });

                if (geojson.features.length === 1 && geojson.features[0].geometry.type === 'Point') {
                     map.flyTo({ center: geojson.features[0].geometry.coordinates, zoom: 16 });
                } else {
                     map.fitBounds(bounds, { padding: 100 });
                }
            }
        } catch (error) {
            console.error("Map update error:", error);
            statusEl.textContent = "ì§€ë„ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.";
        }
    }
    
    // --- 9. ìŒì„± ì¸ì‹  ---
    if (speechRecognitionAvailable) {
        const recognition = new SpeechRecognition();
        recognition.lang = 'ko-KR';
        recognition.continuous = false;
        recognition.interimResults = false;
        btnVoice.addEventListener('click', () => {
            statusEl.textContent = "ë“£ê³  ìˆìŠµë‹ˆë‹¤... ğŸ¤";
            btnVoice.style.backgroundColor = '#dc3545';
            sqlResultEl.textContent = "";
            answerBox.style.display = "none";
            recognition.start();
        });
        recognition.onresult = (event) => {
            const text = event.results[0][0].transcript;
            statusEl.textContent = `ì¸ì‹ëœ TĞµĞºÑÑ‚: "${text}"`;
            sendToBackend(text);
        };
        recognition.onend = () => {
            btnVoice.style.backgroundColor = '#007bff';
        };
        recognition.onerror = (event) => {
            statusEl.textContent = `ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ${event.error}`;
        };
    }
</script>

</body>
</html>